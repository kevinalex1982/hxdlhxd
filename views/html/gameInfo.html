<div class="row">
    <div class="col-sm-16">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">游戏信息
                </h5>
            </div>
            <div class="card-block">
                <ul class="nav nav-tabs" role="tablist" id="usertab">

                    <li class="nav-item own"><a id="owna" class="nav-link active" data-toggle="tab"
                                                     href="#own" role="tab">游戏任务</a>
                    </li>
                    <li class="nav-item managered"><a id="managereda" class="nav-link" data-toggle="tab"
                                                       href="#managered" role="tab">团员的游戏任务</a></li>

                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div class="tab-pane active " id="own" role="tabpanel">
                        <table class="table " id="dataTables-game">
                            <thead>
                            <tr>
                                <th><input type="checkbox" id="employeeCheckAll"></th>
                                <th>分配用户</th>
                                <th>分配人</th>
                                <th>游戏昵称</th>
                                <th>游戏内容</th>
                                <th>淘宝订单号</th>
                                <th>添加时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </div>
                    <div class="tab-pane " id="managered" role="tabpanel">
                        <table class="table " id="dataTables-game-managered">
                            <thead>
                            <tr>
                                <th><input type="checkbox" id="employeeCheckAllManagered"></th>
                                <th>分配用户</th>
                                <th>分配人</th>
                                <th>游戏昵称</th>
                                <th>游戏内容</th>
                                <th>淘宝订单号</th>
                                <th>添加时间</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>

                    </div>


                </div>



            </div>
        </div>
    </div>
</div>
<script>
    var tablesgame;
    var columnGame;
    var userCaptainJson;
    var userMemberJson;
    var insertorupdGame;
    var insertorupdTask;
    var insertorupdProgress;
    var curGameID;
    var curGameNickName;
    var tasklistJson;
    var curTaskID;
    var curTaskName;


    var tablesgameManagered;
    var columnGameManagered;



    $(document).ready(function () {

        if (currole == '1') {
            gameInit(1);
            $(".managered").hide();
        }
        else if (currole == '2') {
            gameInit(2);
            gameInitManagered();
        }
        else if (currole == '3') {
            gameInit(3);
            $(".managered").hide();

        }


    })


    /* game初始化*/
    function gameInit(role) {
        if (role == 1) {
            columnGame = [
                {
                    "data": "id",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {
                        $(nTd).html("<input type='checkbox' name='checkList' value='" + sData + "'>");
                    }
                },
                {"data": "nickname"},
                {"data": "assignernickname"},
                {"data": "gnickname"},
                {"data": "content", "width": "30%"},
                {"data": "tbdd"},
                {
                    "data": "addtime",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {

                        if (sData == '') {
                            $(nTd).html('');
                        } else {
                            $(nTd).html(new Date(sData).toLocaleString());
                        }
                    }
                },
                {
                    "data": "status", "width": "8%",

                    "render": function (data, type, full, meta) {

                        if (data == '0') {
                            return '<span class="status danger">未开始</span>';
                        } else if (data == '1') {

                            return '<span class="status info">正在进行</span>';
                        }
                        else if (data == '2') {

                            return '<span class="status success">完成</span>';
                        }

                    }
                },
                {
                    "data": "id", "width": "15%",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {

                        $(nTd).html("<button type='button' class='btn btn-primary btn-sm datatableEditGame'>修改</button>" +
                                  " <button type='button' class='btn btn-danger btn-sm datatableDeleteGame' >删除</button>" +
                            "<button type='button' class='btn btn-info btn-sm datatableTask'>任务进度</button>");
                    }
                }
                /*   {
                 "data": null,
                 "title": "操作",
                 "defaultContent":
                 }*/
            ];
        } else if (role == 2) {
            columnGame = [
                {
                    "data": "id",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {
                        $(nTd).html("<input type='checkbox' name='checkList' value='" + sData + "'>");
                    }
                },
                {"data": "nickname"},
                {"data": "assignernickname"},
                {"data": "gnickname"},
                {"data": "content", "width": "30%"},
                {"data": "tbdd"},
                {
                    "data": "addtime",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {

                        if (sData == '') {
                            $(nTd).html('');
                        } else {
                            $(nTd).html(new Date(sData).toLocaleString());
                        }
                    }
                },
                {
                    "data": "status", "width": "8%",

                    "render": function (data, type, full, meta) {

                        if (data == '0') {
                            return '<span class="status danger">未开始</span>';
                        } else if (data == '1') {

                            return '<span class="status info">正在进行</span>';
                        }
                        else if (data == '2') {

                            return '<span class="status success">完成</span>';
                        }

                    }
                },
                {
                    "data": "id", "width": "12%",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {

                        $(nTd).html("<button type='button' class='btn btn-primary btn-sm datatableEditGame'>修改</button>" +

                            "<button type='button' class='btn btn-info btn-sm datatableTask'>任务进度</button>");
                    }
                }
                /*   {
                 "data": null,
                 "title": "操作",
                 "defaultContent":
                 }*/
            ];
        } else if (role == 3) {
            columnGame = [
                {
                    "data": "id",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {
                        $(nTd).html("<input type='checkbox' name='checkList' value='" + sData + "'>");
                    }
                },
                {"data": "nickname"},
                {"data": "assignernickname"},
                {"data": "gnickname"},
                {"data": "content", "width": "30%"},
                {"data": "tbdd"},
                {
                    "data": "addtime",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {

                        if (sData == '') {
                            $(nTd).html('');
                        } else {
                            $(nTd).html(new Date(sData).toLocaleString());
                        }
                    }
                },
                {
                    "data": "status", "width": "8%",

                    "render": function (data, type, full, meta) {

                        if (data == '0') {
                            return '<span class="status danger">未开始</span>';
                        } else if (data == '1') {

                            return '<span class="status info">正在进行</span>';
                        }
                        else if (data == '2') {

                            return '<span class="status success">完成</span>';
                        }

                    }
                },
                {
                    "data": "id", "width": "8%",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {

                        $(nTd).html("<button type='button' class='btn btn-info btn-sm datatableTask'>任务进度</button>");
                    }
                }
                /*   {
                 "data": null,
                 "title": "操作",
                 "defaultContent":
                 }*/
            ];
        }
        /* 生成datatable游戏*/
        tablesgame = $('#dataTables-game').DataTable({
            "dom": 'r<"pull-right"<"toolbarGame">>tip',
            lengthChange: false,
            responsive: true,
            processing: true,
            pageLength: 15,
            ordering: false,
            bAutoWidth:false,
            /*       autoWidth: false,*/

            /* data: jsondatatest,*/
            columns: columnGame,
            sPaginationType: "full_numbers",
            oLanguage: {
                "sProcessing": "处理中...",
                "sLengthMenu": "每页 _MENU_ 条记录",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "当前显示第 _START_ 至第 _END_ 条记录，共 _TOTAL_ 条记录。",
                "sInfoEmpty": "当前显示第 0 至 0 条记录，共 0 条记录",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页",
                    "sJump": "跳转"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            "initComplete": function () {

                //加载完成之后 初始化checkbox
                checkbox('dataTables-game');


            },
            "serverSide": true,//服务端进行分页处理
            "ajax": {
                data: function (d) {

                    //默认会有
                    //start，表示要从第几行记录开始显示，例如0表示要取第一行记录开始的页面。
                    //length，表示要取的记录数量，即页面大小。
                    //[order][0][column]参数为0表示第一列，1表示第二列，[order][0][dir]参数为asc，表示要求服务端返回所指向列升序的表。
                    //接住Shift可以选择多列排序，会添加下面的键值对请求
                    //[order][1][column]参数为2表示第三列，3表示第四列，[order][1][dir]参数为asc，表示要求服务端返回所指向列升序的表。
                    //达到多列排序的目的。
                    //search[regex]的默认值为"false"，search[value]里存放的是待搜索字符串，如果没有东西要Search则里面是空字符串。
                    if (role == 1) {
                        return $.extend({}, d, {
                            'param': {usID: null, status: null, assignerid: null}//自己增加个data请求参数
                        })
                    }else
                    if (role == 2) {
                        return $.extend({}, d, {
                            'param': {usID: curuserid, status: null, assignerid: null}//自己增加个data请求参数
                        })
                    }else
                    if (role == 3) {
                     /*   console.log(curuserid);*/
                        return $.extend({}, d, {

                            'param': {usID: curuserid, status: null, assignerid: null}//自己增加个data请求参数
                        })
                    }
                },
                dataSrc: function (json) {
                    //console.log('process response data from server side before display.');
                    return json.data;
                },
                url: "/dldata/getGames",
                type: "POST",
                crossDomain: true
            }
        });

        if (role == 1) {
            $("div.toolbarGame").html(" <button type='button' class='btn btn-info btn-sm ' data-toggle='modal' data-target='#addSomeGamesModal' id='addSomeGamesModalBtn'>批量添加游戏</button>    <button type='button' class='btn btn-danger btn-sm '  id='delGameGroup'>删除选中游戏</button>    <button type='button' class='btn btn-primary btn-sm ' data-toggle='modal' data-target='#addGameModal' id='addGameModalBtn'>添加游戏</button>");
        }
        // 数据编辑
        $('#dataTables-game tbody').on('click', 'button.datatableEditGame', function () {
            var data = tablesgame.row($(this).parents('tr')).data();

            openUpdGameModalInitParam(data, tablesgame);

        });
        /*删除游戏*/
        $('#dataTables-game tbody').on('click', 'button.datatableDeleteGame', function () {

            var data = tablesgame.row($(this).parents('tr')).data();
            swal({
                    title: "确定要删除吗?",
                    text: "删除后无法恢复选项!",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "删除!",
                    closeOnConfirm: false
                },
                function () {
                    $.post("/dldata/delGame", {game: data, curuser: loginUser}, function (result) {
                        if (result == 'success') {
                            tablesgame.ajax.reload();
                            swal("删除成功!", "该行数据被删除.", "success");
                        }
                        else {
                            swal("删除失败!", "请联系管理员.", "error");
                        }
                    })

                });

        });


        // 任务进度
        $('#dataTables-game tbody').on('click', 'button.datatableTask', function () {
            var data = tablesgame.row($(this).parents('tr')).data();

            opentasksModalInitParam(data);

        });

        $("#delGameGroup").on('click', function () {
            swal({
                    title: "确定要删除吗?",
                    text: "删除后无法恢复选项!",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "删除!",
                    closeOnConfirm: false
                },
                function () {

                    var indexend = tablesgame.rows('.selected').data().length;
                    var indexstart = 1;
                    $.each(tablesgame.rows('.selected').data(), function (index, item) {
                        $.post("/dldata/delGame", {game: item, curuser: loginUser}, function (result) {

                            if (result == 'success') {
                                if (indexstart == indexend) {
                                    tablesgame.ajax.reload();
                                    swal("删除成功!", "该行数据被删除.", "success");
                                }
                            }
                            else {
                                swal("删除失败!", "请联系管理员.", "error");
                            }
                            indexstart++;
                        })
                    })
                });

        })
        $.post("/dldata/getUsers", {start: 0, length: 1000, param: {role: 2}}, function (result) {
            userCaptainJson = result.data;
        })
        $.post("/dldata/getUsers", {start: 0, length: 1000, param: {role: 3}}, function (result) {
            userMemberJson = result.data;

        })

        $("#addGameModalBtn").on('click', function () {
            $("#optGCaptain").empty();
            $.each(userCaptainJson, function (index, item) {
                $("#optGCaptain").prepend("<option value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
            })
            $("#optGMember").empty();
            $.each(userMemberJson, function (index, item) {
                $("#optGMember").prepend("<option value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
            })

            insertorupdGame = 1;
            $("#nickGameName").val('');
            $("#gameInfo").val('');
            $("#ttddhForGame").val('');

            $("#GameModalLabel").text('新建游戏');
            $("#userFormGameSelect").val('');
        })


        $("#addSomeGamesModalBtn").on('click', function () {
            $("#gameTextarea").val('');
        })


        //checkbox全选
        $("#employeeCheckAll").click(function () {

            if ($(this).prop("checked")) {
                $("input[name='checkList']:checkbox").prop("checked", true);
                $("tr").addClass('selected');
            } else {
                $("input[name='checkList']:checkbox").prop("checked", false);
                $("tr").removeClass('selected');
            }
        });
    }
    function openUpdGameModalInitParam(seldata, curtable) {
        $("#optGCaptain").empty();
        $.each(userCaptainJson, function (index, item) {
            if (currole == '2') {
                $("#optGCaptain").prepend("<option disabled='disabled' value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
            } else {
                $("#optGCaptain").prepend("<option value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
            }


        })
        $("#optGMember").empty();
        $.each(userMemberJson, function (index, item) {
            $("#optGMember").prepend("<option value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
        })
        insertorupdGame = 2;

        curtableForUpd = curtable;

        gameIDforUpd = seldata.id;
        $("#userFormGameSelect").val($.trim(seldata.userid));
        curGameID = seldata.id;
        $("#nickGameName").val($.trim(seldata.gnickname));
        $("#gameInfo").val($.trim(seldata.content));
        $("#ttddhForGame").val($.trim(seldata.tbdd));
        $("#GameModalLabel").text('修改游戏');
        $("#addGameModal").modal("show");//弹出框show

    }

    function opentasksModalInitParam(seldata) {
        curGameID = seldata.id;
        curGameNickName = seldata.gnickname;

        refreshTasks(true);


    }

    function refreshTasks(show) {
        $.post("/dldata/getTasks", {gameid: curGameID}, function (result) {
            $("#tasklist").empty();
            tasklistJson = result;
            $.each(result, function (index, item) {
                /*      addtime    content gid  id  status  title*/
                var checkedThis;
                checkedThis = item.status == '0' ? 'unchecked' : 'checked';
                var flagThis;
                flagThis = item.status == '0' ? 'text-danger' : 'text-success';
                var domtask = '    <div class="media" id=' + item.id + '>' +
                    '            <div class="media-body">' +
                    '            <h6 class="mt-0 mb-1 " ><h6 class="tasktitle">' + item.title +
                    '            </h6><small class="flagStatus pull-right  ' + flagThis + '"><i class="fa fa-flag"></i></small>' +
                    '            <button type="button" class="btn btn-danger mr-1  pull-right btnDeleteTask">删除</button>' +
                    '            <button type="button" class="btn btn-info mr-1  pull-right btnUpdateTask">修改</button>' +
                    '<button type="button" class="btn btn-success mr-1  pull-right btnprogress">进度</button>' +
                    '            <div class="can-toggle demo-rebrand-2 small mr-5 pull-right">' +
                    '            <input id="checkTaskStatus-' + item.id + '" class="taskstatus" type="checkbox" ' + checkedThis + '>' +
                    '        <label for="checkTaskStatus-' + item.id + '"> ' +
                    '            <div class="can-toggle__switch" data-checked="√"' +
                    '        data-unchecked="X"></div>' +
                    '    </label>' +
                    '        </div>' +
                    '        </h6>' +
                    '        <p class="taskaddtime">' + new Date(item.addtime).toLocaleString() + '</p>' +
                    '        <p class="description taskcontent">' + item.content + '</p>' +
                    '            </div>' +
                    '            </div>';
                $("#tasklist").append(domtask);
            })
            /*删除任务*/
            $(".btnDeleteTask").on('click', function () {
                var parentobj = $(this).parent().parent();
                var tasknameobj = $($(this).parent()[0]).children('.tasktitle')[0].textContent;
                swal({
                        title: "确定要删除吗?",
                        text: "删除后无法恢复选项!",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "删除!",
                        closeOnConfirm: false
                    },
                    function () {
                        $.post("/dldata/delTask", {
                            gamenickname: curGameNickName,
                            taskid: parentobj[0].id,
                            taskname: tasknameobj,
                            curuser: loginUser
                        }, function (result) {
                            if (result == 'success') {
                                $("#" + parentobj[0].id).remove();
                                swal("删除成功!", "该行数据被删除.", "success");
                            }
                            else {
                                swal("删除失败!", "请联系管理员.", "error");
                            }
                        })

                    });
            })

            /*更新任务*/
            $(".btnUpdateTask").on('click', function () {
                var parentobj = $(this).parent().parent();
                var tasknameobj = $($(this).parent()[0]).children('.tasktitle')[0].textContent;
                var taskcontentobj = $($(this).parent()[0]).children('.taskcontent')[0].textContent;

                $("#taskName").val($.trim(tasknameobj));
                $("#taskInfo").val($.trim(taskcontentobj));
                curTaskID = parentobj[0].id;
                curTaskName = tasknameobj;
                insertorupdTask = 2;
                $("#TaskModalLabel").text('修改任务');
                $("#addTaskModal").modal("show");//弹出框show
                /*    swal({
                 title: "确定要删除吗?",
                 text: "删除后无法恢复选项!",
                 type: "warning",
                 showCancelButton: true,
                 confirmButtonColor: "#DD6B55",
                 confirmButtonText: "删除!",
                 closeOnConfirm: false
                 },
                 function () {
                 $.post("/dldata/delTask", {
                 gamenickname: curGameNickName,
                 taskid: parentobj[0].id,
                 taskname: tasknameobj,
                 curuser: loginUser
                 }, function (result) {
                 if (result == 'success') {
                 $("#" + parentobj[0].id).remove();
                 swal("删除成功!", "该行数据被删除.", "success");
                 }
                 else {
                 swal("删除失败!", "请联系管理员.", "error");
                 }
                 })

                 });*/
            })

            /*更新任务状态*/
            $(".taskstatus").on('change', function () {
                var parentobj = $(this).parent().parent().parent();
                var tasknameobj = $($(this).parent().parent()[0]).children('.tasktitle')[0].textContent;
                var flagstatusctrl = $($($(this).parent().parent()[0]).children('.flagStatus')[0]);
                var statusthisctrl = $(this).prop("checked");
                $.post("/dldata/changeTaskStatus", {
                    gamenickname: curGameNickName,
                    taskid: parentobj[0].id,
                    taskname: tasknameobj,
                    curuser: loginUser,
                    status: statusthisctrl == true ? "1" : "0"
                }, function (result) {
                    if (result == 'success') {
                        if (statusthisctrl == true) {
                            if (flagstatusctrl.hasClass("text-danger")) {
                                flagstatusctrl.removeClass("text-danger");
                                flagstatusctrl.addClass("text-success");
                            }
                        }
                        if (statusthisctrl == false) {
                            if (flagstatusctrl.hasClass("text-success")) {
                                flagstatusctrl.removeClass("text-success");
                                flagstatusctrl.addClass("text-danger");
                            }
                        }

                        swal("变更状态成功!", "变更状态.", "success");
                    }
                    else {
                        swal("变更状态失败!", "请联系管理员.", "error");
                    }
                })


            })

            // 进度
            $('.btnprogress').on('click', function () {
                var parentobj = $(this).parent().parent();
                var tasknameobj = $($(this).parent()[0]).children('.tasktitle')[0].textContent;
                curTaskID = parentobj[0].id;
                curTaskName = tasknameobj;
                refreshProgresses(true);
            });
            if (show == true) {
                $("#tasksModal").modal("show");//弹出框show
            }
        })
    }

    function refreshProgresses(show) {
        $.post("/dldata/getProgresses", {taskid: curTaskID}, function (result) {
            $("#progresslist").empty();
            progresslistJson = result;
            $.each(result, function (index, item) {
                var domprogress = '    <div class="media" id=' + item.id + '>' +
                    '            <div class="media-body">' +
                    '            <h6 class="mt-0 mb-1 " >' +
                    '            <button type="button" class="btn btn-danger mr-1  pull-right btnDeleteprogress">删除</button>' +
                        /*       '            <button type="button" class="btn btn-info mr-1  pull-right btnUpdateprogress">修改</button>' +*/
                    '            <div class="can-toggle demo-rebrand-2 small mr-5 pull-right">' +
                    '        </div>' +
                    '        </h6>' +
                    '        <p class="progressaddtime">' + new Date(item.addtime).toLocaleString() + '</p>' +
                    '        <p class="description progresscontent">' + item.content + '</p>' +
                    '            </div>' +
                    '            </div>';
                $("#progresslist").append(domprogress);
            })
            /*删除进度*/
            $(".btnDeleteprogress").on('click', function () {
                var parentobj = $(this).parent().parent().parent();
                var progressidforthis = parentobj[0].id;
                /*   console.log(parentobj);
                 console.log(progressidforthis);*/
                swal({
                        title: "确定要删除吗?",
                        text: "删除后无法恢复选项!",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "删除!",
                        closeOnConfirm: false
                    },
                    function () {
                        $.post("/dldata/delProgress", {
                            gamenickname: curGameNickName,
                            progressid: progressidforthis,
                            tasktitle: curTaskName,
                            curuser: loginUser
                        }, function (result) {
                            if (result == 'success') {
                                $("#" + progressidforthis).remove();
                                swal("删除成功!", "该行数据被删除.", "success");
                            }
                            else {
                                swal("删除失败!", "请联系管理员.", "error");
                            }
                        })

                    });
            })

            /* /!*更新任务*!/
             $(".btnUpdateprogress").on('click', function () {
             var parentobj = $(this).parent().parent();
             var tasknameobj = $($(this).parent()[0]).children('.tasktitle')[0].textContent;
             var taskcontentobj =$($(this).parent()[0]).children('.taskcontent')[0].textContent;

             $("#taskName").val($.trim(tasknameobj));
             $("#taskInfo").val($.trim(taskcontentobj));
             curTaskID = parentobj[0].id;
             curTaskName = tasknameobj;
             insertorupdTask = 2;
             $("#TaskModalLabel").text('修改任务');
             $("#addTaskModal").modal("show");//弹出框show
             /!*    swal({
             title: "确定要删除吗?",
             text: "删除后无法恢复选项!",
             type: "warning",
             showCancelButton: true,
             confirmButtonColor: "#DD6B55",
             confirmButtonText: "删除!",
             closeOnConfirm: false
             },
             function () {
             $.post("/dldata/delTask", {
             gamenickname: curGameNickName,
             taskid: parentobj[0].id,
             taskname: tasknameobj,
             curuser: loginUser
             }, function (result) {
             if (result == 'success') {
             $("#" + parentobj[0].id).remove();
             swal("删除成功!", "该行数据被删除.", "success");
             }
             else {
             swal("删除失败!", "请联系管理员.", "error");
             }
             })

             });*!/
             })*/

            if (show == true) {
                $("#progressesModal").modal("show");//弹出框show
            }
        })
    }

    //选中一行 checkbox选中
    function checkbox(tableId) {
        //每次加载时都先清理
        $('#' + tableId + ' tbody').off("click", "tr");
        $('#' + tableId + ' tbody').on("click", "tr", function () {

            $(this).toggleClass('selected');
            if ($(this).hasClass("selected")) {
                $(this).find("input").prop("checked", true);
            } else {
                $(this).find("input").prop("checked", false);
            }
        });


    }




    /* game初始化*/
    function gameInitManagered() {

            columnGameManagered = [
                {
                    "data": "id",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {
                        $(nTd).html("<input type='checkbox' name='checkListManagered' value='" + sData + "'>");
                    }
                },
                {"data": "nickname"},
                {"data": "assignernickname"},
                {"data": "gnickname"},
                {"data": "content", "width": "30%"},
                {"data": "tbdd"},
                {
                    "data": "addtime",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {

                        if (sData == '') {
                            $(nTd).html('');
                        } else {
                            $(nTd).html(new Date(sData).toLocaleString());
                        }
                    }
                },
                {
                    "data": "status", "width": "8%",

                    "render": function (data, type, full, meta) {

                        if (data == '0') {
                            return '<span class="status danger">未开始</span>';
                        } else if (data == '1') {

                            return '<span class="status info">正在进行</span>';
                        }
                        else if (data == '2') {

                            return '<span class="status success">完成</span>';
                        }

                    }
                },
                {
                    "data": "id", "width": "12%",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {

                        $(nTd).html("<button type='button' class='btn btn-primary btn-sm datatableEditGameManagered'>修改</button>" +

                            "<button type='button' class='btn btn-info btn-sm datatableTaskManagered'>任务进度</button>");
                    }
                }
                /*   {
                 "data": null,
                 "title": "操作",
                 "defaultContent":
                 }*/
            ];


        /* 生成datatable游戏*/
        tablesgameManagered = $('#dataTables-game-managered').DataTable({
            "dom": 'r<"pull-right"<"toolbarGame">>tip',
            lengthChange: false,
            responsive: true,
            processing: true,
            pageLength: 15,
            ordering: false,
            bAutoWidth:false,
            /*       autoWidth: false,*/

            /* data: jsondatatest,*/
            columns: columnGameManagered,
            sPaginationType: "full_numbers",
            oLanguage: {
                "sProcessing": "处理中...",
                "sLengthMenu": "每页 _MENU_ 条记录",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "当前显示第 _START_ 至第 _END_ 条记录，共 _TOTAL_ 条记录。",
                "sInfoEmpty": "当前显示第 0 至 0 条记录，共 0 条记录",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页",
                    "sJump": "跳转"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            "initComplete": function () {

                //加载完成之后 初始化checkbox
                checkboxManagered('dataTables-game-managered');


            },
            "serverSide": true,//服务端进行分页处理
            "ajax": {
                data: function (d) {

                    //默认会有
                    //start，表示要从第几行记录开始显示，例如0表示要取第一行记录开始的页面。
                    //length，表示要取的记录数量，即页面大小。
                    //[order][0][column]参数为0表示第一列，1表示第二列，[order][0][dir]参数为asc，表示要求服务端返回所指向列升序的表。
                    //接住Shift可以选择多列排序，会添加下面的键值对请求
                    //[order][1][column]参数为2表示第三列，3表示第四列，[order][1][dir]参数为asc，表示要求服务端返回所指向列升序的表。
                    //达到多列排序的目的。
                    //search[regex]的默认值为"false"，search[value]里存放的是待搜索字符串，如果没有东西要Search则里面是空字符串。

                        return $.extend({}, d, {
                            'param': {usID: null, status: null, assignerid: curuserid}//自己增加个data请求参数
                        })

                },
                dataSrc: function (json) {
                    console.log(json.data);

                    return json.data;
                },
                url: "/dldata/getGames",
                type: "POST",
                crossDomain: true
            }
        });


        // 数据编辑
        $('#dataTables-game-managered tbody').on('click', 'button.datatableEditGameManagered', function () {
            var data = tablesgameManagered.row($(this).parents('tr')).data();

            openUpdGameModalInitParamManagered(data, tablesgameManagered);

        });
        /*删除游戏*/
        $('#dataTables-game-managered tbody').on('click', 'button.datatableDeleteGameManagered', function () {

            var data = tablesgameManagered.row($(this).parents('tr')).data();
            swal({
                    title: "确定要删除吗?",
                    text: "删除后无法恢复选项!",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "删除!",
                    closeOnConfirm: false
                },
                function () {
                    $.post("/dldata/delGame", {game: data, curuser: loginUser}, function (result) {
                        if (result == 'success') {
                            tablesgameManagered.ajax.reload();
                            swal("删除成功!", "该行数据被删除.", "success");
                        }
                        else {
                            swal("删除失败!", "请联系管理员.", "error");
                        }
                    })

                });

        });


        // 任务进度
        $('#dataTables-game-managered tbody').on('click', 'button.datatableTaskManagered', function () {
            var data = tablesgameManagered.row($(this).parents('tr')).data();

            opentasksModalInitParamManagered(data);

        });

        $("#delGameGroupManagered").on('click', function () {
            swal({
                    title: "确定要删除吗?",
                    text: "删除后无法恢复选项!",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "删除!",
                    closeOnConfirm: false
                },
                function () {

                    var indexend = tablesgameManagered.rows('.selected').data().length;
                    var indexstart = 1;
                    $.each(tablesgameManagered.rows('.selected').data(), function (index, item) {
                        $.post("/dldata/delGame", {game: item, curuser: loginUser}, function (result) {

                            if (result == 'success') {
                                if (indexstart == indexend) {
                                    tablesgameManagered.ajax.reload();
                                    swal("删除成功!", "该行数据被删除.", "success");
                                }
                            }
                            else {
                                swal("删除失败!", "请联系管理员.", "error");
                            }
                            indexstart++;
                        })
                    })
                });

        })
        $.post("/dldata/getUsers", {start: 0, length: 1000, param: {role: 2}}, function (result) {
            userCaptainJson = result.data;
        })
        $.post("/dldata/getUsers", {start: 0, length: 1000, param: {role: 3}}, function (result) {
            userMemberJson = result.data;

        })

        $("#addGameModalBtnManagered").on('click', function () {
            $("#optGCaptain").empty();
            $.each(userCaptainJson, function (index, item) {
                $("#optGCaptain").prepend("<option value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
            })
            $("#optGMember").empty();
            $.each(userMemberJson, function (index, item) {
                $("#optGMember").prepend("<option value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
            })

            insertorupdGame = 1;
            $("#nickGameName").val('');
            $("#gameInfo").val('');
            $("#ttddhForGame").val('');

            $("#GameModalLabel").text('新建游戏');
            $("#userFormGameSelect").val('');
        })


        $("#addSomeGamesModalBtnManagered").on('click', function () {
            $("#gameTextarea").val('');
        })


        //checkbox全选
        $("#employeeCheckAllManagered").click(function () {

            if ($(this).prop("checked")) {
                $("input[name='checkListManagered']:checkbox").prop("checked", true);
                $("tr").addClass('selected');
            } else {
                $("input[name='checkListManagered']:checkbox").prop("checked", false);
                $("tr").removeClass('selected');
            }
        });
    }

    function openUpdGameModalInitParamManagered(seldata, curtable) {
        $("#optGCaptain").empty();
        $.each(userCaptainJson, function (index, item) {
            if (currole == '2') {
                $("#optGCaptain").prepend("<option disabled='disabled' value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
            } else {
                $("#optGCaptain").prepend("<option value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
            }


        })
        $("#optGMember").empty();
        $.each(userMemberJson, function (index, item) {
            $("#optGMember").prepend("<option value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
        })
        insertorupdGame = 2;

        curtableForUpd = curtable;

        gameIDforUpd = seldata.id;
        $("#userFormGameSelect").val($.trim(seldata.userid));
        curGameID = seldata.id;
        $("#nickGameName").val($.trim(seldata.gnickname));
        $("#gameInfo").val($.trim(seldata.content));
        $("#ttddhForGame").val($.trim(seldata.tbdd));
        $("#GameModalLabel").text('修改游戏');
        $("#addGameModal").modal("show");//弹出框show

    }

    function opentasksModalInitParamManagered(seldata) {
        curGameID = seldata.id;
        curGameNickName = seldata.gnickname;

        refreshTasks(true);


    }

    function refreshTasks(show) {
        $.post("/dldata/getTasks", {gameid: curGameID}, function (result) {
            $("#tasklist").empty();
            tasklistJson = result;
            $.each(result, function (index, item) {
                /*      addtime    content gid  id  status  title*/
                var checkedThis;
                checkedThis = item.status == '0' ? 'unchecked' : 'checked';
                var flagThis;
                flagThis = item.status == '0' ? 'text-danger' : 'text-success';
                var domtask = '    <div class="media" id=' + item.id + '>' +
                    '            <div class="media-body">' +
                    '            <h6 class="mt-0 mb-1 " ><h6 class="tasktitle">' + item.title +
                    '            </h6><small class="flagStatus pull-right  ' + flagThis + '"><i class="fa fa-flag"></i></small>' +
                    '            <button type="button" class="btn btn-danger mr-1  pull-right btnDeleteTask">删除</button>' +
                    '            <button type="button" class="btn btn-info mr-1  pull-right btnUpdateTask">修改</button>' +
                    '<button type="button" class="btn btn-success mr-1  pull-right btnprogress">进度</button>' +
                    '            <div class="can-toggle demo-rebrand-2 small mr-5 pull-right">' +
                    '            <input id="checkTaskStatus-' + item.id + '" class="taskstatus" type="checkbox" ' + checkedThis + '>' +
                    '        <label for="checkTaskStatus-' + item.id + '"> ' +
                    '            <div class="can-toggle__switch" data-checked="√"' +
                    '        data-unchecked="X"></div>' +
                    '    </label>' +
                    '        </div>' +
                    '        </h6>' +
                    '        <p class="taskaddtime">' + new Date(item.addtime).toLocaleString() + '</p>' +
                    '        <p class="description taskcontent">' + item.content + '</p>' +
                    '            </div>' +
                    '            </div>';
                $("#tasklist").append(domtask);
            })
            /*删除任务*/
            $(".btnDeleteTask").on('click', function () {
                var parentobj = $(this).parent().parent();
                var tasknameobj = $($(this).parent()[0]).children('.tasktitle')[0].textContent;
                swal({
                        title: "确定要删除吗?",
                        text: "删除后无法恢复选项!",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "删除!",
                        closeOnConfirm: false
                    },
                    function () {
                        $.post("/dldata/delTask", {
                            gamenickname: curGameNickName,
                            taskid: parentobj[0].id,
                            taskname: tasknameobj,
                            curuser: loginUser
                        }, function (result) {
                            if (result == 'success') {
                                $("#" + parentobj[0].id).remove();
                                swal("删除成功!", "该行数据被删除.", "success");
                            }
                            else {
                                swal("删除失败!", "请联系管理员.", "error");
                            }
                        })

                    });
            })

            /*更新任务*/
            $(".btnUpdateTask").on('click', function () {
                var parentobj = $(this).parent().parent();
                var tasknameobj = $($(this).parent()[0]).children('.tasktitle')[0].textContent;
                var taskcontentobj = $($(this).parent()[0]).children('.taskcontent')[0].textContent;

                $("#taskName").val($.trim(tasknameobj));
                $("#taskInfo").val($.trim(taskcontentobj));
                curTaskID = parentobj[0].id;
                curTaskName = tasknameobj;
                insertorupdTask = 2;
                $("#TaskModalLabel").text('修改任务');
                $("#addTaskModal").modal("show");//弹出框show
                /*    swal({
                 title: "确定要删除吗?",
                 text: "删除后无法恢复选项!",
                 type: "warning",
                 showCancelButton: true,
                 confirmButtonColor: "#DD6B55",
                 confirmButtonText: "删除!",
                 closeOnConfirm: false
                 },
                 function () {
                 $.post("/dldata/delTask", {
                 gamenickname: curGameNickName,
                 taskid: parentobj[0].id,
                 taskname: tasknameobj,
                 curuser: loginUser
                 }, function (result) {
                 if (result == 'success') {
                 $("#" + parentobj[0].id).remove();
                 swal("删除成功!", "该行数据被删除.", "success");
                 }
                 else {
                 swal("删除失败!", "请联系管理员.", "error");
                 }
                 })

                 });*/
            })

            /*更新任务状态*/
            $(".taskstatus").on('change', function () {
                var parentobj = $(this).parent().parent().parent();
                var tasknameobj = $($(this).parent().parent()[0]).children('.tasktitle')[0].textContent;
                var flagstatusctrl = $($($(this).parent().parent()[0]).children('.flagStatus')[0]);
                var statusthisctrl = $(this).prop("checked");
                $.post("/dldata/changeTaskStatus", {
                    gamenickname: curGameNickName,
                    taskid: parentobj[0].id,
                    taskname: tasknameobj,
                    curuser: loginUser,
                    status: statusthisctrl == true ? "1" : "0"
                }, function (result) {
                    if (result == 'success') {
                        if (statusthisctrl == true) {
                            if (flagstatusctrl.hasClass("text-danger")) {
                                flagstatusctrl.removeClass("text-danger");
                                flagstatusctrl.addClass("text-success");
                            }
                        }
                        if (statusthisctrl == false) {
                            if (flagstatusctrl.hasClass("text-success")) {
                                flagstatusctrl.removeClass("text-success");
                                flagstatusctrl.addClass("text-danger");
                            }
                        }

                        swal("变更状态成功!", "变更状态.", "success");
                    }
                    else {
                        swal("变更状态失败!", "请联系管理员.", "error");
                    }
                })


            })

            // 进度
            $('.btnprogress').on('click', function () {
                var parentobj = $(this).parent().parent();
                var tasknameobj = $($(this).parent()[0]).children('.tasktitle')[0].textContent;
                curTaskID = parentobj[0].id;
                curTaskName = tasknameobj;
                refreshProgresses(true);
            });
            if (show == true) {
                $("#tasksModal").modal("show");//弹出框show
            }
        })
    }

    function refreshProgresses(show) {
        $.post("/dldata/getProgresses", {taskid: curTaskID}, function (result) {
            $("#progresslist").empty();
            progresslistJson = result;
            $.each(result, function (index, item) {
                var domprogress = '    <div class="media" id=' + item.id + '>' +
                    '            <div class="media-body">' +
                    '            <h6 class="mt-0 mb-1 " >' +
                    '            <button type="button" class="btn btn-danger mr-1  pull-right btnDeleteprogress">删除</button>' +
                        /*       '            <button type="button" class="btn btn-info mr-1  pull-right btnUpdateprogress">修改</button>' +*/
                    '            <div class="can-toggle demo-rebrand-2 small mr-5 pull-right">' +
                    '        </div>' +
                    '        </h6>' +
                    '        <p class="progressaddtime">' + new Date(item.addtime).toLocaleString() + '</p>' +
                    '        <p class="description progresscontent">' + item.content + '</p>' +
                    '            </div>' +
                    '            </div>';
                $("#progresslist").append(domprogress);
            })
            /*删除进度*/
            $(".btnDeleteprogress").on('click', function () {
                var parentobj = $(this).parent().parent().parent();
                var progressidforthis = parentobj[0].id;
                /*   console.log(parentobj);
                 console.log(progressidforthis);*/
                swal({
                        title: "确定要删除吗?",
                        text: "删除后无法恢复选项!",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "删除!",
                        closeOnConfirm: false
                    },
                    function () {
                        $.post("/dldata/delProgress", {
                            gamenickname: curGameNickName,
                            progressid: progressidforthis,
                            tasktitle: curTaskName,
                            curuser: loginUser
                        }, function (result) {
                            if (result == 'success') {
                                $("#" + progressidforthis).remove();
                                swal("删除成功!", "该行数据被删除.", "success");
                            }
                            else {
                                swal("删除失败!", "请联系管理员.", "error");
                            }
                        })

                    });
            })

            /* /!*更新任务*!/
             $(".btnUpdateprogress").on('click', function () {
             var parentobj = $(this).parent().parent();
             var tasknameobj = $($(this).parent()[0]).children('.tasktitle')[0].textContent;
             var taskcontentobj =$($(this).parent()[0]).children('.taskcontent')[0].textContent;

             $("#taskName").val($.trim(tasknameobj));
             $("#taskInfo").val($.trim(taskcontentobj));
             curTaskID = parentobj[0].id;
             curTaskName = tasknameobj;
             insertorupdTask = 2;
             $("#TaskModalLabel").text('修改任务');
             $("#addTaskModal").modal("show");//弹出框show
             /!*    swal({
             title: "确定要删除吗?",
             text: "删除后无法恢复选项!",
             type: "warning",
             showCancelButton: true,
             confirmButtonColor: "#DD6B55",
             confirmButtonText: "删除!",
             closeOnConfirm: false
             },
             function () {
             $.post("/dldata/delTask", {
             gamenickname: curGameNickName,
             taskid: parentobj[0].id,
             taskname: tasknameobj,
             curuser: loginUser
             }, function (result) {
             if (result == 'success') {
             $("#" + parentobj[0].id).remove();
             swal("删除成功!", "该行数据被删除.", "success");
             }
             else {
             swal("删除失败!", "请联系管理员.", "error");
             }
             })

             });*!/
             })*/

            if (show == true) {
                $("#progressesModal").modal("show");//弹出框show
            }
        })
    }

    //选中一行 checkbox选中
    function checkboxManagered(tableId) {
        //每次加载时都先清理
        $('#' + tableId + ' tbody').off("click", "tr");
        $('#' + tableId + ' tbody').on("click", "tr", function () {

            $(this).toggleClass('selected');
            if ($(this).hasClass("selected")) {
                $(this).find("input").prop("checked", true);
            } else {
                $(this).find("input").prop("checked", false);
            }
        });


    }

    /*测试接口*/
    function buildGameTable() {
        /* $.post("/dldata/getGames", {start: 0, length: 20, usID: 0}, function (result) {
         console.log(result);
         })*/
    }
</script>