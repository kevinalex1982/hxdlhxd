<div class="row">
    <div class="col-sm-16">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">游戏信息
                </h5>
            </div>
            <div class="card-block">

                <table class="table " id="dataTables-game">
                    <thead>
                    <tr>
                        <th><input type="checkbox" id="employeeCheckAll"></th>
                        <th>分配用户</th>
                        <th>上级(分配人)</th>
                        <th>游戏昵称</th>
                        <th>游戏内容</th>
                        <th>淘宝订单号</th>
                        <th>添加时间</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody>

                    </tbody>
                </table>


            </div>
        </div>
    </div>
</div>
<script>
    var tablesgame;
    var columnGame;
    var userCaptainJson;
    var userMemberJson;
    var insertorupdGame;
    var curGameID;
    $(document).ready(function () {

        if (currole == '1') {
            gameInit(1);
            buildGameTable();

        }
        else if (currole == '2') {
            gameInit(2);
        }
        else if (currole == '3') {

        }


    })


    /* game初始化*/
    function gameInit(role) {
        if (role == 1) {
            columnGame = [
                {
                    "data": "id",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {
                   /*     console.log(nTd);
                        console.log(sData);
                        console.log(oData);
                        console.log(iRow);
                        console.log(iCol);*/
                        $(nTd).html("<input type='checkbox' name='checkList' value='" + sData + "'>");
                    }
                },
                {"data": "nickname"},
                {"data": "assignernickname"},
                {"data": "gnickname"},
                {"data": "content" ,"width": "30%" },
                {"data": "tbdd"},
                {"data": "addtime"},
                {
                    "data": "status",

                    "render": function (data, type, full, meta) {
                        console.log(data);
                        if (data == '0') {
                            return '<span class="status success">√</span>';
                        } else {

                            return '<span class="status danger">X</span>';
                        }

                    }
                },
                {
                    "data": "id",
                    "createdCell": function (nTd, sData, oData, iRow, iCol) {
                        /*     console.log(nTd);
                         console.log(sData);
                         console.log(oData);
                         console.log(iRow);
                         console.log(iCol);*/
                        $(nTd).html( "<button type='button' class='btn btn-primary btn-sm datatableEditGame'>修改</button>" +
                            " <button type='button' class='btn btn-danger btn-sm datatableDeleteGame' >删除</button>" +
                            "<button type='button' class='btn btn-info btn-sm datatableProgress'>任务进度</button>");
                    }
                }
             /*   {
                    "data": null,
                    "title": "操作",
                    "defaultContent":
                }*/
            ];
        } else {
            columnGame = [

                {"data": "nickname"},

                {"data": "gnickname"},
                {"data": "content"},
                {"data": "tbdd"},
                {"data": "addtime"},
                {
                    "data": "status",

                    "render": function (data, type, full, meta) {
                        console.log(data);
                        if (data == '0') {
                            return '<span class="status danger">X</span>';
                        } else {

                            return '<span class="status success">OK</span>';
                        }

                    }
                },
                {
                    "data": null,
                    "title": "操作",
                    "defaultContent": "<button type='button' class='btn btn-primary btn-sm datatableEditGame'>修改</button>" +
                    "<button type='button' class='btn btn-info btn-sm datatableProgress'>任务进度</button>"
                }
            ];
        }
        /* 生成datatable游戏*/
        tablesgame = $('#dataTables-game').DataTable({
            "dom": 'r<"pull-right"<"toolbarGame">>tip',
            lengthChange: false,
            responsive: true,
            processing: true,
            pageLength: 15,
            ordering: false,
            autoWidth:false,
            "scrollX": true,
            /* data: jsondatatest,*/
            columns: columnGame,
            sPaginationType: "full_numbers",
            oLanguage: {
                "sProcessing": "处理中...",
                "sLengthMenu": "每页 _MENU_ 条记录",
                "sZeroRecords": "没有匹配结果",
                "sInfo": "当前显示第 _START_ 至第 _END_ 条记录，共 _TOTAL_ 条记录。",
                "sInfoEmpty": "当前显示第 0 至 0 条记录，共 0 条记录",
                "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
                "sInfoPostFix": "",
                "sSearch": "搜索:",
                "sUrl": "",
                "sEmptyTable": "表中数据为空",
                "sLoadingRecords": "载入中...",
                "sInfoThousands": ",",
                "oPaginate": {
                    "sFirst": "首页",
                    "sPrevious": "上页",
                    "sNext": "下页",
                    "sLast": "末页",
                    "sJump": "跳转"
                },
                "oAria": {
                    "sSortAscending": ": 以升序排列此列",
                    "sSortDescending": ": 以降序排列此列"
                }
            },
            "initComplete": function () {

                //加载完成之后 初始化checkbox
                checkbox('dataTables-game');


            },
            "serverSide": true,//服务端进行分页处理
            "ajax": {
                data: function (d) {
                    console.log('custom request');
                    //默认会有
                    //start，表示要从第几行记录开始显示，例如0表示要取第一行记录开始的页面。
                    //length，表示要取的记录数量，即页面大小。
                    //[order][0][column]参数为0表示第一列，1表示第二列，[order][0][dir]参数为asc，表示要求服务端返回所指向列升序的表。
                    //接住Shift可以选择多列排序，会添加下面的键值对请求
                    //[order][1][column]参数为2表示第三列，3表示第四列，[order][1][dir]参数为asc，表示要求服务端返回所指向列升序的表。
                    //达到多列排序的目的。
                    //search[regex]的默认值为"false"，search[value]里存放的是待搜索字符串，如果没有东西要Search则里面是空字符串。
                    return $.extend({}, d, {
                        'param': {usID: null, curuser: loginUser}//自己增加个data请求参数
                    })
                },
                dataSrc: function (json) {
                    console.log('process response data from server side before display.');
                    return json.data;
                },
                url: "/dldata/getGameWithAssigners",
                type: "POST",
                crossDomain: true
            }
        });

        if (role == 1) {

            $("div.toolbarGame").html("<button type='button' class='btn btn-danger btn-sm '  id='delGameGroup'>删除选中游戏</button>    <button type='button' class='btn btn-primary btn-sm ' data-toggle='modal' data-target='#addGameModal' id='addGameModalBtn'>添加游戏</button>");
        }
        // 数据编辑
        $('#dataTables-game tbody').on('click', 'button.datatableEditGame', function () {
            var data = tablesgame.row($(this).parents('tr')).data();

            openUpdGameModalInitParam(data, tablesgame);

        });
        /*删除游戏*/
        $('#dataTables-game tbody').on('click', 'button.datatableDeleteGame', function () {
            console.log($(this));
            var data = tablesgame.row($(this).parents('tr')).data();

            console.log(data.gnickname);
            console.log(data.id);
            swal({
                    title: "确定要删除吗?",
                    text: "删除后无法恢复选项!",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "删除!",
                    closeOnConfirm: false
                },
                function () {
                    $.post("/dldata/delGame", {game: data, curuser: loginUser}, function (result) {
                        if (result == 'success') {
                            tablesgame.ajax.reload();
                            swal("删除成功!", "该行数据被删除.", "success");
                        }
                        else {
                            swal("删除失败!", "请联系管理员.", "error");
                        }
                    })

                });

        });

        $("#delGameGroup").on('click', function () {
            console.log(tablesgame.rows('.selected').data());
            swal({
                    title: "确定要删除吗?",
                    text: "删除后无法恢复选项!",
                    type: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#DD6B55",
                    confirmButtonText: "删除!",
                    closeOnConfirm: false
                },
                function () {

                    var indexend = tablesgame.rows('.selected').data().length;
                    var indexstart = 1;
                    $.each(tablesgame.rows('.selected').data(), function (index, item) {
                        $.post("/dldata/delGame", {game: item, curuser: loginUser}, function (result) {

                            if (result == 'success') {

                                console.log(indexstart);
                                console.log(indexend);
                                if (indexstart == indexend) {
                                    tablesgame.ajax.reload();
                                    swal("删除成功!", "该行数据被删除.", "success");
                                }
                            }
                            else {
                                swal("删除失败!", "请联系管理员.", "error");
                            }
                            indexstart++;
                        })
                    })


                });

        })
        $.post("/dldata/getUsers", {start: 0, length: 1000, param: {role: 2}}, function (result) {
            userCaptainJson = result.data;
        })
        $.post("/dldata/getUsers", {start: 0, length: 1000, param: {role: 3}}, function (result) {
            userMemberJson = result.data;

        })

        $("#addGameModalBtn").on('click', function () {
            $("#optGCaptain").empty();
            $.each(userCaptainJson, function (index, item) {
                $("#optGCaptain").prepend("<option value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
            })
            $("#optGMember").empty();
            $.each(userMemberJson, function (index, item) {
                $("#optGMember").prepend("<option value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
            })
            /* console.log(userCaptainJson);
             console.log(userMemberJson);*/
            insertorupdGame = 1;
            $("#nickGameName").val('');
            $("#gameInfo").val('');
            $("#ttddhForGame").val('');

            $("#GameModalLabel").text('新建游戏');
            $("#userFormGameSelect").val('');
        })

        //checkbox全选
        $("#employeeCheckAll").click(function () {

            if ($(this).prop("checked")) {
                $("input[name='checkList']:checkbox").prop("checked", true);
                $("tr").addClass('selected');
            } else {
                $("input[name='checkList']:checkbox").prop("checked", false);
                $("tr").removeClass('selected');
            }
        });
    }
    function openUpdGameModalInitParam(seldata, curtable) {
        $("#optGCaptain").empty();
        $.each(userCaptainJson, function (index, item) {
            $("#optGCaptain").prepend("<option value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
        })
        $("#optGMember").empty();
        $.each(userMemberJson, function (index, item) {
            $("#optGMember").prepend("<option value=" + item.id + ">" + item.nickname + "</option>"); //为Select插入一个Option(第一个位置)
        })
        insertorupdGame = 2;

        curtableForUpd = curtable;
        console.log(seldata);
        gameIDforUpd = seldata.id;
        $("#userFormGameSelect").val(seldata.userid);
        curGameID = seldata.id;
        $("#nickGameName").val(seldata.gnickname);
        $("#gameInfo").val(seldata.content);
        $("#ttddhForGame").val(seldata.tbdd);
        $("#GameModalLabel").text('修改游戏');
        $("#addGameModal").modal("show");//弹出框show

    }

    //选中一行 checkbox选中
    function checkbox(tableId) {
        //每次加载时都先清理
        $('#' + tableId + ' tbody').off("click", "tr");
        $('#' + tableId + ' tbody').on("click", "tr", function () {
            console.log($(this));
            $(this).toggleClass('selected');
            if ($(this).hasClass("selected")) {
                $(this).find("input").prop("checked", true);
            } else {
                $(this).find("input").prop("checked", false);
            }
        });


    }

    /*测试接口*/
    function buildGameTable() {
        /* $.post("/dldata/getGames", {start: 0, length: 20, usID: 0}, function (result) {
         console.log(result);
         })*/
    }
</script>